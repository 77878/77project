<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>投資筆記 Cloud</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(reg => {
                reg.onupdatefound = () => {
                    const installingWorker = reg.installing;
                    installingWorker.onstatechange = () => {
                        if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // 偵測到新版本，立即重新載入
                            window.location.reload();
                        }
                    };
                };
            });
        }
    </script>

    <style>
        body { background-color: #0b1120; color: #f1f5f9; font-family: system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .card { background-color: #1e293b; border-radius: 20px; padding: 1.25rem; border: 1px solid #334155; }
        /* 加大版輸入框 */
        input { 
            background: #0f172a; 
            border: 1px solid #475569; 
            border-radius: 12px; 
            padding: 12px; 
            color: #38bdf8; 
            width: 100%; 
            text-align: right; 
            font-weight: 800; 
            font-size: 1.1rem; 
        }
        input:focus { border-color: #38bdf8; outline: none; background: #1e293b; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; font-weight: 700; margin-bottom: 4px; display: block; }
        .action-card { border-radius: 16px; padding: 1rem; border-left: 5px solid #10b981; background: rgba(16, 185, 129, 0.1); }
        .status-badge { font-size: 11px; padding: 2px 10px; border-radius: 99px; font-weight: bold; }
        .gap-red { color: #f87171; } .gap-green { color: #4ade80; }
    </style>
</head>
<body class="p-4 pb-12">
    <div class="max-w-md mx-auto space-y-4">
        
        <div class="card flex items-center justify-between gap-4">
            <div style="width: 120px; height: 120px;"><canvas id="assetChart"></canvas></div>
            <div class="flex-1 space-y-3">
                <div><p class="stat-label uppercase">總資產淨值</p><p id="total_val" class="text-xl font-black text-white">--</p></div>
                <div class="grid grid-cols-2 gap-2 border-t border-slate-700 pt-2 text-center">
                    <div><p class="stat-label font-black text-blue-400">Beta</p><p id="q_beta" class="text-lg font-bold">--</p></div>
                    <div><p class="stat-label font-black text-orange-400">平衡倒數</p><p id="rebalance_timer" class="text-lg font-bold">--</p></div>
                </div>
                <div id="chart_legend" class="text-[10px] space-y-1"></div>
            </div>
        </div>

        <div class="card border-l-4 border-l-emerald-500">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-[10px] font-black text-emerald-400 uppercase">執行動作 & 比例缺口</h2>
                <span id="supply_status" class="status-badge">--</span>
            </div>
            <div id="gap_analysis" class="grid grid-cols-3 gap-2 mb-4 text-[10px] font-mono border-b border-slate-700 pb-3"></div>
            <div id="instruction_content" class="space-y-3 text-sm"></div>
        </div>

        <div class="card">
            <h2 class="text-[10px] font-black text-slate-400 mb-3 uppercase">資產部位盤點 (萬元)</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2"><span class="stat-label">現有資產 (006208 等)</span><input type="number" id="v_base" value="66" oninput="saveAndCalc()"></div>
                <div><span class="stat-label">原型 (00662)</span><input type="number" id="v_etf" value="20" oninput="saveAndCalc()"></div>
                <div><span class="stat-label">槓桿 (00631L)</span><input type="number" id="v_lev" value="20" oninput="saveAndCalc()"></div>
                <div><span class="stat-label">債券 (865B)</span><input type="number" id="v_cash" value="0" oninput="saveAndCalc()"></div>
                <div><span class="stat-label">流動現金</span><input type="number" id="v_pocket" value="18.5" oninput="saveAndCalc()"></div>
            </div>
        </div>

        <div class="card bg-slate-900/50 border-slate-800">
            <h2 class="text-[10px] font-black text-indigo-400 mb-3 uppercase font-bold">風險監控</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><span class="stat-label uppercase font-bold text-zinc-400">質押市值</span><input type="number" id="m_pledge" value="20" oninput="saveAndCalc()"></div>
                <div><span class="stat-label uppercase font-bold text-zinc-400">借款金額</span><input type="number" id="m_loan" value="0" oninput="saveAndCalc()"></div>
            </div>
            <div class="bg-black/40 p-4 rounded-xl flex justify-between items-center border border-slate-800">
                <span class="stat-label m-0 uppercase text-zinc-400 font-bold">當前維持率</span>
                <span id="m_rate_display" class="text-3xl font-black">--%</span>
            </div>
            <div class="mt-6">
                <input type="range" id="v_drop" min="0" max="40" value="0" class="w-full h-3 bg-slate-700 rounded-lg appearance-none cursor-pointer" oninput="saveAndCalc()">
                <p id="drop_text" class="
