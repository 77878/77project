<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>æŠ•è³‡ç­†è¨˜ V6.9</title>

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="theme-color" content="#0b1120">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // è‡ªå‹•æ›´æ–°èˆ‡ Service Worker è¨»å†Š
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(reg => {
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                window.location.reload();
                            }
                        };
                    };
                }).catch(err => console.log('SW Error:', err));
            });
        }
    </script>
    
    <style>
        body { background-color: #0b1120; color: #f1f5f9; font-family: system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .card { background-color: #1e293b; border-radius: 20px; padding: 1.25rem; border: 1px solid #334155; }
        input { 
            background: #0f172a; border: 1px solid #475569; border-radius: 12px; padding: 10px; 
            color: #38bdf8; width: 100%; text-align: right; font-weight: 800; font-size: 1.1rem; 
        }
        .stat-label { font-size: 0.65rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; }
        .gap-red { color: #f87171; font-weight: 900; } 
        .gap-green { color: #4ade80; font-weight: 900; }
        .action-box { border-radius: 12px; padding: 10px; background: rgba(56, 189, 248, 0.1); border-left: 4px solid #38bdf8; }
    </style>
</head>
<body class="p-4 pb-12 text-sm">
    <div class="max-w-md mx-auto space-y-4">
        
        <div class="card space-y-4">
            <div class="flex items-center gap-4">
                <div class="relative" style="width: 130px; height: 130px; flex-shrink: 0;">
                    <canvas id="assetChart"></canvas>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="stat-label">ç¸½è³‡ç”¢æ·¨å€¼</p>
                    <p id="total_val" class="text-2xl font-black text-white mb-2 truncate">-- è¬</p>
                    
                    <div id="gap_analysis" class="grid grid-cols-3 gap-1 border-y border-slate-700/50 py-2 my-2 text-center">
                    </div>

                    <div class="flex justify-between items-center px-1">
                        <div class="flex gap-2">
                            <div><p class="stat-label text-blue-400">Beta</p><p id="q_beta" class="text-[11px] font-bold">--</p></div>
                            <div><p class="stat-label text-indigo-400">Sharpe</p><p id="q_sharpe" class="text-[11px] font-bold">--</p></div>
                        </div>
                        <div class="text-right">
                            <p class="stat-label text-orange-400">å¹³è¡¡å€’æ•¸</p>
                            <p id="rebalance_timer" class="text-[11px] font-bold text-white">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-l-4 border-l-emerald-500 py-3">
            <div class="flex justify-between items-center mb-1">
                <h2 class="text-[10px] font-black text-emerald-400 uppercase italic">æ™ºèƒ½åŸ·è¡Œå»ºè­°</h2>
                <span id="supply_status" class="text-[9px] bg-slate-700 px-2 py-0.5 rounded text-slate-300">--</span>
            </div>
            <div id="instruction_content" class="text-[11px] leading-relaxed"></div>
        </div>

        <div class="card bg-indigo-900/10 border-indigo-500/30">
            <span class="stat-label text-indigo-400 font-black">ğŸ’° é¡å¤–çé‡‘æŠ•å…¥ (è¬å…ƒ)</span>
            <input type="number" id="v_bonus" value="0" class="mt-1" style="color:#a855f7; border-color:#a855f7;" oninput="run()">
        </div>

        <div class="card space-y-4">
            <div><span class="stat-label text-blue-300">èˆªç©ºæ¯è‰¦ (006208)</span><input type="number" id="v_base" value="66" oninput="run()"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><span class="stat-label">åŸå‹ (00662)</span><input type="number" id="v_etf" value="20" oninput="run()"></div>
                <div><span class="stat-label">æ§“æ¡¿ (00631L)</span><input type="number" id="v_lev" value="20" oninput="run()"></div>
                <div><span class="stat-label">å‚µåˆ¸ (865B)</span><input type="number" id="v_cash" value="0" oninput="run()"></div>
                <div><span class="stat-label">ç¾é‡‘éƒ¨ä½</span><input type="number" id="v_pocket" value="18.5" oninput="run()"></div>
            </div>
        </div>

        <div class="card bg-slate-900/50">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><span class="stat-label">è³ªæŠ¼å¸‚å€¼</span><input type="number" id="m_pledge" value="20" oninput="run()"></div>
                <div><span class="stat-label">å€Ÿæ¬¾é‡‘é¡</span><input type="number" id="m_loan" value="0" oninput="run()"></div>
            </div>
            <div class="bg-black/40 p-4 rounded-xl flex justify-between items-center border border-slate-800">
                <span class="stat-label m-0">ç¶­æŒç‡</span>
                <span id="m_rate_display" class="text-3xl font-black text-emerald-400">--%</span>
            </div>
            <input type="range" id="v_drop" min="0" max="40" value="0" class="w-full mt-6" oninput="run()">
            <p id="drop_text" class="text-center text-[10px] text-slate-500 mt-2 font-bold uppercase">æ¨¡æ“¬è·Œå¹…: 0%</p>
        </div>
    </div>

    <script>
        let myChart;

        function run() {
            try {
                const vB = parseFloat(document.getElementById('v_base').value) || 0;
                const vE = parseFloat(document.getElementById('v_etf').value) || 0;
                const vL = parseFloat(document.getElementById('v_lev').value) || 0;
                const vC = parseFloat(document.getElementById('v_cash').value) || 0;
                const vP = parseFloat(document.getElementById('v_pocket').value) || 0;
                const mL = parseFloat(document.getElementById('m_loan').value) || 0;
                const mP = parseFloat(document.getElementById('m_pledge').value) || 0;
                const drop = parseFloat(document.getElementById('v_drop').value) || 0;
                const bonus = parseFloat(document.getElementById('v_bonus').value) || 0;

                const total = vB + vE + vL + vC + vP;
                const battleTotal = vE + vL + vC;
                document.getElementById('total_val').innerText = total.toFixed(1) + " è¬";

                const mRate = mL > 0 ? ((mP * (1 - drop/100)) / mL) * 100 : 999;
                const rateDisp = document.getElementById('m_rate_display');
                rateDisp.innerText = mL > 0 ? mRate.toFixed(0) + "%" : "N/A";
                rateDisp.className = `text-3xl font-black ${mRate < 140 ? 'text-red-500 animate-bounce' : mRate < 166 ? 'text-yellow-500' : 'text-emerald-400'}`;

                const tE = battleTotal * 0.4, tL = battleTotal * 0.4, tC = battleTotal * 0.2;
                const gE = vE - tE, gL = vL - tL, gC = vC - tC;
                const formatGap = (v) => v > 0 ? `<span class="gap-red">+${v.toFixed(1)}</span>` : `<span class="gap-green">${v.toFixed(1)}</span>`;
                
                document.getElementById('gap_analysis').innerHTML = `
                    <div><p class='stat-label text-[8px]'>åŸå‹</p>${formatGap(gE)}</div>
                    <div><p class='stat-label text-[8px]'>æ§“æ¡¿</p>${formatGap(gL)}</div>
                    <div><p class='stat-label text-[8px]'>å‚µåˆ¸</p>${formatGap(gC)}</div>`;

                const insEl = document.getElementById('instruction_content');
                let tips = "";
                if (mRate < 166 && mL > 0) tips = `<div class="action-box border-red-500 text-red-400 font-bold">ğŸš¨ å„ªå…ˆè£œæ•‘ç¶­æŒç‡ï¼</div>`;
                else if (drop >= 20) tips = `<div class="action-box border-yellow-500 text-yellow-500 font-bold">ğŸ¯ çµäººæº–å‰‡ï¼šé€²æ”» 00631Lï¼</div>`;
                else if (bonus > 0) tips = `<div class="action-box border-indigo-500 text-indigo-300">ğŸ åˆ†é…ï¼šåŸå‹+${(bonus*0.4).toFixed(1)}, æ§“æ¡¿+${(bonus*0.4).toFixed(1)}, å‚µåˆ¸+${(bonus*0.2).toFixed(1)}</div>`;
                else tips = `<p class="text-slate-500 italic text-center py-1">æˆ°é¬¥éƒ¨ä½åˆè¨ˆ: ${battleTotal.toFixed(1)} è¬</p>`;
                insEl.innerHTML = tips;

                const wB = total > 0 ? vB/total : 0, wE = total > 0 ? vE/total : 0, wL = total > 0 ? vL/total : 0, wC = total > 0 ? vC/total : 0;
                document.getElementById('q_beta').innerText = (wB*1 + wE*1.1 + wL*2.1).toFixed(2);
                document.getElementById('q_sharpe').innerText = (wB*0.6 + wE*0.7 + wL*0.5 + wC*0.4).toFixed(2);

                const now = new Date();
                const target = now > new Date(now.getFullYear(), 5, 30) ? new Date(now.getFullYear(), 11, 31) : new Date(now.getFullYear(), 5, 30);
                document.getElementById('rebalance_timer').innerText = Math.ceil((target - now) / 86400000) + "å¤©";

                if (myChart) {
                    myChart.data.datasets[0].data = [vE, vL, vC];
                    myChart.update();
                }
                localStorage.setItem('invest_v6_final', JSON.stringify({vB,vE,vL,vC,vP,mL,mP,drop,bonus}));
            } catch (e) { console.error(e); }
        }

        window.onload = () => {
            const ctx = document.getElementById('assetChart');
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { 
                    labels: ['åŸå‹', 'æ§“æ¡¿', 'å‚µåˆ¸'],
                    datasets: [{ data: [1, 1, 1], backgroundColor: ['#3b82f6', '#a855f7', '#10b981'], borderWidth: 0 }] 
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%', 
                    plugins: { 
                        legend: { 
                            display: true, 
                            position: 'bottom',
                            labels: { color: '#94a3b8', font: { size: 9 }, boxWidth: 8, padding: 4 }
                        } 
                    } 
                }
            });
            const saved = localStorage.getItem('invest_v6_final');
            if (saved) {
                const d = JSON.parse(saved);
                document.getElementById('v_base').value = d.vB || 66;
                document.getElementById('v_etf').value = d.vE || 20;
                document.getElementById('v_lev').value = d.vL || 20;
                document.getElementById('v_cash').value = d.vC || 0;
                document.getElementById('v_pocket').value = d.vP || 18.5;
                document.getElementById('m_loan').value = d.mL || 0;
                document.getElementById('m_pledge').value = d.mP || 20;
                document.getElementById('v_drop').value = d.drop || 0;
                document.getElementById('v_bonus').value = d.bonus || 0;
            }
            run();
        };
    </script>
</body>
</html>
