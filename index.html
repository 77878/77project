<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æŠ•è³‡ç­†è¨˜ V6</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(reg => {
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // åµæ¸¬åˆ°ä»£ç¢¼è®Šå‹•ï¼Œç«‹å³å¼·åˆ¶åˆ·æ–°
                                window.location.reload();
                            }
                        };
                    };
                });
            });
        }
    </script>

    <style>
        body { background-color: #0b1120; color: #f1f5f9; font-family: system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .card { background-color: #1e293b; border-radius: 20px; padding: 1.25rem; border: 1px solid #334155; }
        input { 
            background: #0f172a; 
            border: 1px solid #475569; 
            border-radius: 12px; 
            padding: 12px; 
            color: #38bdf8; 
            width: 100%; 
            text-align: right; 
            font-weight: 800; 
            font-size: 1.1rem; 
        }
        input:focus { border-color: #38bdf8; outline: none; background: #1e293b; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; font-weight: 700; margin-bottom: 4px; display: block; }
        .action-card { border-radius: 16px; padding: 1rem; border-left: 5px solid #10b981; background: rgba(16, 185, 129, 0.1); }
        .status-badge { font-size: 11px; padding: 2px 10px; border-radius: 99px; font-weight: bold; }
        .gap-red { color: #f87171; } .gap-green { color: #4ade80; }
    </style>
</head>
<body class="p-4 pb-12">
    <div class="max-w-md mx-auto space-y-4">
        
        <div class="card flex items-center justify-between gap-4">
            <div style="width: 120px; height: 120px;"><canvas id="assetChart"></canvas></div>
            <div class="flex-1 space-y-3">
                <div><p class="stat-label">ç¸½è³‡ç”¢æ·¨å€¼</p><p id="total_val" class="text-xl font-black text-white">--</p></div>
                <div class="grid grid-cols-2 gap-2 border-t border-slate-700 pt-2 text-center">
                    <div><p class="stat-label font-black text-blue-400">Beta</p><p id="q_beta" class="text-lg font-bold">--</p></div>
                    <div><p class="stat-label font-black text-orange-400">å¹³è¡¡å€’æ•¸</p><p id="rebalance_timer" class="text-lg font-bold">--</p></div>
                </div>
                <div id="chart_legend" class="text-[10px] space-y-1"></div>
            </div>
        </div>

        <div class="card border-l-4 border-l-emerald-500">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-[10px] font-black text-emerald-400 uppercase">åŸ·è¡Œå‹•ä½œ & æ¯”ä¾‹ç¼ºå£</h2>
                <span id="supply_status" class="status-badge">--</span>
            </div>
            <div id="gap_analysis" class="grid grid-cols-3 gap-2 mb-4 text-[10px] font-mono border-b border-slate-700 pb-3"></div>
            <div id="instruction_content" class="space-y-3 text-sm"></div>
        </div>

        <div class="card">
            <h2 class="text-[10px] font-black text-slate-400 mb-3 uppercase">è³‡ç”¢éƒ¨ä½ç›¤é» (è¬å…ƒ)</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2"><span class="stat-label">ç¾æœ‰è³‡ç”¢ (006208 ç­‰)</span><input type="number" id="v_base" value="66" oninput="saveAndCalc()"></div>
                <div><span class="stat-label">åŸå‹ (00662)</span><input type="number" id="v_etf" value="20" oninput="saveAndCalc()"></div>
                <div><span class="stat-label">æ§“æ¡¿ (00631L)</span><input type="number" id="v_lev" value="20" oninput="saveAndCalc()"></div>
                <div><span class="stat-label">å‚µåˆ¸ (865B)</span><input type="number" id="v_cash" value="0" oninput="saveAndCalc()"></div>
                <div><span class="stat-label">æµå‹•ç¾é‡‘</span><input type="number" id="v_pocket" value="18.5" oninput="saveAndCalc()"></div>
            </div>
        </div>

        <div class="card bg-slate-900/50 border-slate-800">
            <h2 class="text-[10px] font-black text-indigo-400 mb-3 uppercase font-bold">é¢¨éšªç›£æ§</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><span class="stat-label uppercase font-bold text-zinc-400">è³ªæŠ¼å¸‚å€¼</span><input type="number" id="m_pledge" value="20" oninput="saveAndCalc()"></div>
                <div><span class="stat-label uppercase font-bold text-zinc-400">å€Ÿæ¬¾é‡‘é¡</span><input type="number" id="m_loan" value="0" oninput="saveAndCalc()"></div>
            </div>
            <div class="bg-black/40 p-4 rounded-xl flex justify-between items-center border border-slate-800">
                <span class="stat-label m-0 uppercase text-zinc-400 font-bold">ç•¶å‰ç¶­æŒç‡</span>
                <span id="m_rate_display" class="text-3xl font-black">--%</span>
            </div>
            <div class="mt-6">
                <input type="range" id="v_drop" min="0" max="40" value="0" class="w-full h-3 bg-slate-700 rounded-lg appearance-none cursor-pointer" oninput="saveAndCalc()">
                <p id="drop_text" class="text-center text-[11px] text-slate-500 mt-2 font-bold uppercase tracking-widest">æ¨¡æ“¬è·Œå¹…: 0%</p>
            </div>
        </div>
    </div>

    <script>
        let myChart;

        function saveAndCalc() {
            const data = { 
                vB: document.getElementById('v_base').value, 
                vE: document.getElementById('v_etf').value, 
                vL: document.getElementById('v_lev').value, 
                vC: document.getElementById('v_cash').value, 
                vP: document.getElementById('v_pocket').value, 
                mL: document.getElementById('m_loan').value, 
                mP: document.getElementById('m_pledge').value, 
                vD: document.getElementById('v_drop').value 
            };
            // ä½¿ç”¨æ–°çš„ Key ç¢ºä¿æ•¸æ“šä¸€è‡´æ€§
            localStorage.setItem('invest_v6_final_data', JSON.stringify(data));
            calculate(data);
        }

        function calculate(data) {
            const now = new Date();
            const year = now.getFullYear();
            const d1 = new Date(year, 5, 30), d2 = new Date(year, 11, 31);
            let target = now > d1 ? d2 : d1;
            if (now > d2) target = new Date(year + 1, 5, 30);
            document.getElementById('rebalance_timer').innerText = Math.ceil((target - now) / 86400000) + "D";

            const isSupplied = now.getDate() >= 11;
            const drop = parseFloat(data.vD) || 0;
            document.getElementById('drop_text').innerText = `æ¨¡æ“¬è·Œå¹…: ${drop}%`;

            const badge = document.getElementById('supply_status');
            badge.innerText = isSupplied ? "æœ¬æœˆå·²æŠ•" : "å¾… 11 è™Ÿå…¥é‡‘";
            badge.className = isSupplied ? "status-badge bg-slate-700 text-slate-400" : "status-badge bg-blue-600 text-white animate-pulse";

            const vB = parseFloat(data.vB)||0, vE = parseFloat(data.vE)||0, vL = parseFloat(data.vL)||0, vC = parseFloat(data.vC)||0, vP = parseFloat(data.vP)||0, mL = parseFloat(data.mL)||0, mP = parseFloat(data.mP)||0;
            const total = vB + vE + vL + vC + vP, battleTotal = vE + vL + vC;

            document.getElementById('total_val').innerText = total.toFixed(1) + " è¬";
            document.getElementById('q_beta').innerText = total > 0 ? ((vB/total)*1 + (vE/total)*1.1 + (vL/total)*2.1).toFixed(2) : "0.00";

            const mRate = mL > 0 ? ((mP * (1 - drop/100)) / mL) * 100 : 999;
            const rateDisp = document.getElementById('m_rate_display');
            rateDisp.innerText = mL > 0 ? mRate.toFixed(0) + "%" : "N/A";
            rateDisp.className = `text-3xl font-black ${mRate < 140 ? 'text-red-500 animate-bounce' : mRate < 166 ? 'text-yellow-500' : 'text-emerald-400'}`;

            const tE = battleTotal * 0.4, tL = battleTotal * 0.4, tC = battleTotal * 0.2;
            const gE = vE - tE, gL = vL - tL, gC = vC - tC;
            const formatGap = (v) => v > 0 ? `<span class="gap-red">+${v.toFixed(1)}</span>` : `<span class="gap-green">${v.toFixed(1)}</span>`;

            document.getElementById('gap_analysis').innerHTML = `<div class="text-center"><p>åŸå‹</p>${formatGap(gE)}</div><div class="text-center border-x border-slate-700"><p>æ§“æ¡¿</p>${formatGap(gL)}</div><div class="text-center"><p>å‚µåˆ¸</p>${formatGap(gC)}</div>`;
            document.getElementById('chart_legend').innerHTML = `<div class="flex justify-between"><span>åŸå‹</span><span>${(battleTotal>0?vE/battleTotal*100:0).toFixed(0)}%</span></div><div class="flex justify-between"><span>æ§“æ¡¿</span><span>${(battleTotal>0?vL/battleTotal*100:0).toFixed(0)}%</span></div><div class="flex justify-between"><span>å‚µåˆ¸</span><span>${(battleTotal>0?vC/battleTotal*100:0).toFixed(0)}%</span></div>`;

            const insEl = document.getElementById('instruction_content');
            let hunt = drop >= 20 ? 10 : drop >= 10 ? 5 : 0;
            if (mRate < 166 && mL > 0) {
                insEl.innerHTML = `<div class="action-card border-red-500">ğŸš¨ ç¶­æŒç‡è­¦å‘Šï¼šå»ºè­°è²·å…¥ 00662 +2.5 è¬æˆ–å„Ÿé‚„æ¬ æ¬¾ã€‚</div>`;
            } else if (hunt > 0) {
                insEl.innerHTML = `<div class="action-card border-yellow-500">ğŸ¯ é€²æ”»æŒ‡ä»¤ï¼šå»ºè­°è²·å…¥ ${hunt >= 10 ? '00631L' : '00662'} +${hunt} è¬ã€‚</div>`;
            } else {
                insEl.innerHTML = isSupplied ? `<p class="text-center py-4 text-slate-500 italic">ç›®å‰è³‡ç”¢é…ç½®æ­£å¸¸ã€‚</p>` : `<p class="text-blue-400 text-xs font-bold italic mb-2">ğŸ“… 11 è™Ÿè£œçµ¦å»ºè­° (è¬å…ƒ)</p><div class="grid grid-cols-3 gap-2 text-center text-[11px]"><div class="bg-slate-800 p-2 rounded">åŸå‹<br>+${(Math.max(0,tE-vE+0.1)).toFixed(1)}</div><div class="bg-slate-800 p-2 rounded">æ§“æ¡¿<br>+${(Math.max(0,tL-vL+0.1)).toFixed(1)}</div><div class="bg-slate-800 p-2 rounded">å‚µåˆ¸<br>+${(Math.max(0,tC-vC+0.1)).toFixed(1)}</div></div>`;
            }

            if (myChart) { myChart.data.datasets[0].data = [vE, vL, vC]; myChart.update(); }
        }

        window.onload = () => {
            const ctx = document.getElementById('assetChart').getContext('2d');
            myChart = new Chart(ctx, { 
                type: 'doughnut', 
                data: { datasets: [{ data: [40,40,20], backgroundColor: ['#3b82f6', '#a855f7', '#10b981'], borderWidth: 0 }] }, 
                options: { cutout: '75%', plugins: { legend: { display: false } } } 
            });
            const s = localStorage.getItem('invest_v6_final_data');
            if (s) { 
                const d = JSON.parse(s); 
                document.getElementById('v_base').value = d.vB || 66; 
                document.getElementById('v_etf').value = d.vE || 20; 
                document.getElementById('v_lev').value = d.vL || 20; 
                document.getElementById('v_cash').value = d.vC || 0; 
                document.getElementById('v_pocket').value = d.vP || 18.5; 
                document.getElementById('m_loan').value = d.mL || 0; 
                document.getElementById('m_pledge').value = d.mP || 20; 
                document.getElementById('v_drop').value = d.vD || 0; 
                calculate(d); 
            } else { saveAndCalc(); }
        };
    </script>
</body>
</html>
