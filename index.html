<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>投資筆記 V6.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0b1120; color: #f1f5f9; font-family: system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .card { background-color: #1e293b; border-radius: 20px; padding: 1.25rem; border: 1px solid #334155; }
        input { background: #0f172a; border: 1px solid #475569; border-radius: 12px; padding: 12px; color: #38bdf8; width: 100%; text-align: right; font-weight: 800; font-size: 1.1rem; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; font-weight: 700; margin-bottom: 4px; display: block; }
        .status-badge { font-size: 11px; padding: 2px 10px; border-radius: 99px; font-weight: bold; }
        .gap-red { color: #f87171; } .gap-green { color: #4ade80; }
    </style>
</head>
<body class="p-4 pb-12">
    <div class="max-w-md mx-auto space-y-4">
        <div class="card flex items-center justify-between gap-4">
            <div style="width: 100px; height: 100px;"><canvas id="assetChart"></canvas></div>
            <div class="flex-1 space-y-2">
                <p class="stat-label">總資產淨值</p>
                <p id="total_val" class="text-xl font-black text-white">計算中...</p>
                <div class="grid grid-cols-2 gap-2 border-t border-slate-700 pt-2">
                    <div class="text-center"><p class="stat-label text-blue-400">Beta</p><p id="q_beta" class="text-lg font-bold">--</p></div>
                    <div class="text-center"><p class="stat-label text-orange-400">平衡</p><p id="rebalance_timer" class="text-lg font-bold">--</p></div>
                </div>
            </div>
        </div>

        <div id="instruction_box" class="card border-l-4 border-l-emerald-500">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-[10px] font-black text-emerald-400 uppercase">執行建議</h2>
                <span id="supply_status" class="status-badge">--</span>
            </div>
            <div id="gap_analysis" class="grid grid-cols-3 gap-2 mb-2 text-[10px] font-mono border-b border-slate-700 pb-2"></div>
            <div id="instruction_content" class="text-sm"></div>
        </div>

        <div class="card">
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2"><span class="stat-label">現有資產</span><input type="number" id="v_base" value="66" oninput="run()"></div>
                <div><span class="stat-label">原型 (00662)</span><input type="number" id="v_etf" value="20" oninput="run()"></div>
                <div><span class="stat-label">槓桿 (00631L)</span><input type="number" id="v_lev" value="20" oninput="run()"></div>
                <div><span class="stat-label">債券 (865B)</span><input type="number" id="v_cash" value="0" oninput="run()"></div>
                <div><span class="stat-label">現金</span><input type="number" id="v_pocket" value="18.5" oninput="run()"></div>
            </div>
        </div>

        <div class="card bg-slate-900/50">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><span class="stat-label">質押市值</span><input type="number" id="m_pledge" value="20" oninput="run()"></div>
                <div><span class="stat-label">借款金額</span><input type="number" id="m_loan" value="0" oninput="run()"></div>
            </div>
            <div class="bg-black/40 p-4 rounded-xl flex justify-between items-center border border-slate-800">
                <span class="stat-label m-0 font-bold">維持率</span>
                <span id="m_rate_display" class="text-3xl font-black text-emerald-400">--%</span>
            </div>
            <input type="range" id="v_drop" min="0" max="40" value="0" class="w-full mt-4" oninput="run()">
            <p id="drop_text" class="text-center text-[10px] text-slate-500 mt-2 font-bold uppercase">模擬跌幅: 0%</p>
        </div>
    </div>

    <script>
        let myChart;

        // 強制初始化的核心函數
        function run() {
            try {
                const d = {
                    vB: parseFloat(document.getElementById('v_base').value) || 0,
                    vE: parseFloat(document.getElementById('v_etf').value) || 0,
                    vL: parseFloat(document.getElementById('v_lev').value) || 0,
                    vC: parseFloat(document.getElementById('v_cash').value) || 0,
                    vP: parseFloat(document.getElementById('v_pocket').value) || 0,
                    mL: parseFloat(document.getElementById('m_loan').value) || 0,
                    mP: parseFloat(document.getElementById('m_pledge').value) || 0,
                    vD: parseFloat(document.getElementById('v_drop').value) || 0
                };

                // 1. 計算總值
                const total = d.vB + d.vE + d.vL + d.vC + d.vP;
                const battleTotal = d.vE + d.vL + d.vC;
                document.getElementById('total_val').innerText = total.toFixed(1) + " 萬";

                // 2. 維持率與風險
                const drop = d.vD;
                document.getElementById('drop_text').innerText = `模擬跌幅: ${drop}%`;
                const mRate = d.mL > 0 ? ((d.mP * (1 - drop/100)) / d.mL) * 100 : 999;
                const rateDisp = document.getElementById('m_rate_display');
                rateDisp.innerText = d.mL > 0 ? mRate.toFixed(0) + "%" : "N/A";
                rateDisp.className = `text-3xl font-black ${mRate < 140 ? 'text-red-500 animate-bounce' : mRate < 166 ? 'text-yellow-500' : 'text-emerald-400'}`;

                // 3. 缺口計算 (4:4:2)
                const tE = battleTotal * 0.4, tL = battleTotal * 0.4, tC = battleTotal * 0.2;
                const gE = d.vE - tE, gL = d.vL - tL, gC = d.vC - tC;
                const formatGap = (v) => v > 0 ? `<span class="gap-red">+${v.toFixed(1)}</span>` : `<span class="gap-green">${v.toFixed(1)}</span>`;
                document.getElementById('gap_analysis').innerHTML = `
                    <div class="text-center"><p>原型</p>${formatGap(gE)}</div>
                    <div class="text-center border-x border-slate-700"><p>槓桿</p>${formatGap(gL)}</div>
                    <div class="text-center"><p>債券</p>${formatGap(gC)}</div>`;

                // 4. 更新圖表
                if (myChart) {
                    myChart.data.datasets[0].data = [d.vE, d.vL, d.vC];
                    myChart.update();
                }

                // 5. 存檔
                localStorage.setItem('invest_v6_data_v2', JSON.stringify(d));
                
                // 這裡簡化了日期計算，避免報錯
                document.getElementById('rebalance_timer').innerText = "半年";
            } catch (e) {
                console.error("計算發生錯誤:", e);
            }
        }

        window.onload = () => {
            // 初始化圖表
            try {
                const ctx = document.getElementById('assetChart').getContext('2d');
                myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: { datasets: [{ data: [1, 1, 1], backgroundColor: ['#3b82f6', '#a855f7', '#10b981'], borderWidth: 0 }] },
                    options: { cutout: '70%', plugins: { legend: { display: false } } }
                });
            } catch (e) { console.log("Chart 載入失敗，但不影響計算"); }

            // 讀取存檔
            const saved = localStorage.getItem('invest_v6_data_v2');
            if (saved) {
                const d = JSON.parse(saved);
                document.getElementById('v_base').value = d.vB || 66;
                document.getElementById('v_etf').value = d.vE || 20;
                document.getElementById('v_lev').value = d.vL || 20;
                document.getElementById('v_cash').value = d.vC || 0;
                document.getElementById('v_pocket').value = d.vP || 18.5;
                document.getElementById('m_loan').value = d.mL || 0;
                document.getElementById('m_pledge').value = d.mP || 20;
                document.getElementById('v_drop').value = d.vD || 0;
            }
            run(); // 執行第一次計算
        };
    </script>
</body>
</html>
